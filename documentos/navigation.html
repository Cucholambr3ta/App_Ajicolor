<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis del Sistema de Navegaci√≥n - App AjiColor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 30px;
            border-bottom: 4px solid #764ba2;
            padding-bottom: 15px;
            text-align: center;
        }

        h2 {
            color: #764ba2;
            font-size: 2em;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-left: 10px;
            border-left: 5px solid #667eea;
        }

        h3 {
            color: #5a67d8;
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 15px;
            background: linear-gradient(to right, #f0f4ff, transparent);
            padding: 10px 15px;
            border-radius: 5px;
        }

        h4 {
            color: #4c51bf;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
            color: #444;
        }

        ul, ol {
            margin-left: 30px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 10px;
            color: #555;
        }

        code {
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e53e3e;
            font-size: 0.9em;
        }

        pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        pre code {
            background: transparent;
            color: #e2e8f0;
            padding: 0;
            font-size: 0.95em;
        }

        .highlight {
            background: linear-gradient(120deg, #ffd60a 0%, #ffd60a 100%);
            background-repeat: no-repeat;
            background-size: 100% 30%;
            background-position: 0 90%;
            padding: 2px 0;
        }

        .box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .box-info {
            background: #ebf8ff;
            border-color: #3182ce;
        }

        .box-warning {
            background: #fffaf0;
            border-color: #ed8936;
        }

        .box-success {
            background: #f0fff4;
            border-color: #38a169;
        }

        .diagram {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .flow-step {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 10px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .arrow {
            display: inline-block;
            color: #667eea;
            font-size: 2em;
            margin: 0 10px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f7fafc;
        }

        .folder-tree {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            line-height: 1.8;
        }

        .folder {
            color: #ffd60a;
            font-weight: bold;
        }

        .file {
            color: #68d391;
        }

        .annotation {
            color: #9f7aea;
            font-style: italic;
        }

        .nav-graph {
            background: #f7fafc;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .screen-box {
            display: inline-block;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß≠ An√°lisis del Sistema de Navegaci√≥n</h1>

        <h2>üéØ Prop√≥sito de la Navegaci√≥n en Compose</h2>
        <p>
            El sistema de navegaci√≥n en Jetpack Compose proporciona una <span class="highlight">forma declarativa y tipo-safe</span>
            de gestionar las transiciones entre pantallas. <strong>Navigation Compose</strong> es el componente oficial de Android
            para implementar la navegaci√≥n en aplicaciones modernas con Compose.
        </p>

        <div class="box box-info">
            <h4>üîë Conceptos Fundamentales</h4>
            <ul>
                <li><strong>NavController:</strong> Gestiona la pila de navegaci√≥n y las transiciones</li>
                <li><strong>NavHost:</strong> Contenedor que muestra el destino actual</li>
                <li><strong>Routes:</strong> Identificadores √∫nicos de tipo String para cada pantalla</li>
                <li><strong>Sealed Classes:</strong> Definiciones tipo-safe de rutas con Kotlin</li>
                <li><strong>Back Stack:</strong> Pila de navegaci√≥n que gestiona el bot√≥n "Atr√°s"</li>
            </ul>
        </div>

        <h2>üìÇ Estructura de /navigation</h2>
        <div class="folder-tree">
üìÅ navigation/
‚îú‚îÄ‚îÄ üìÑ <span class="file">Screen.kt</span>              <span class="annotation">// Definici√≥n tipo-safe de rutas</span>
‚îú‚îÄ‚îÄ üìÑ <span class="file">AppNavigation.kt</span>       <span class="annotation">// Configuraci√≥n del NavHost</span>
‚îî‚îÄ‚îÄ üìÑ <span class="file">NavigationEvent.kt</span>     <span class="annotation">// Eventos de navegaci√≥n desde ViewModel</span>
        </div>

        <h2>üó∫Ô∏è Definici√≥n de Rutas - Screen.kt</h2>
        <p>
            Las rutas se definen usando una <code>sealed class</code> que proporciona seguridad de tipos y
            evita errores de escritura en strings.
        </p>

        <div class="box box-success">
            <h4>üìù C√≥digo: Screen.kt</h4>
            <pre><code>// Sealed class para rutas tipo-safe
sealed class Screen(val route: String) {

    // Rutas simples (sin argumentos)
    data object StartScreen : Screen(route = "start_page")
    data object Init : Screen(route = "init_page")
    data object Login : Screen(route = "login")
    data object Registro : Screen(route = "registro")
    data object Home : Screen(route = "home_page")
    data object Profile : Screen(route = "profile_page")
    data object Cart : Screen(route = "cart_page")
    data object Catalogo : Screen(route = "catalogo")
    data object OrderHistory : Screen(route = "order_history_page")

    // Rutas con argumentos
    data class DetalleProducto(val productoId: String) :
        Screen(route = "producto/{productoId}") {
        companion object {
            const val routePattern = "producto/{productoId}"
            fun createRoute(productoId: String) = "producto/$productoId"
        }
    }

    data class DetallePedido(val numeroPedido: String) :
        Screen(route = "detalle_pedido/{numeroPedido}") {
        companion object {
            const val routePattern = "detalle_pedido/{numeroPedido}"
            fun createRoute(numeroPedido: String) =
                "detalle_pedido/$numeroPedido"
        }
    }

    data class Success(val numeroPedido: String?) :
        Screen(route = "success/{numeroPedido}") {
        companion object {
            const val routePattern = "success/{numeroPedido}"
            fun createRoute(numeroPedido: String) = "success/$numeroPedido"
        }
    }
}</code></pre>
        </div>

        <h4>üéØ Ventajas de Sealed Classes:</h4>
        <table>
            <thead>
                <tr>
                    <th>Ventaja</th>
                    <th>Descripci√≥n</th>
                    <th>Beneficio</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Type-Safety</strong></td>
                    <td>Errores detectados en compilaci√≥n</td>
                    <td>Menos errores en producci√≥n</td>
                </tr>
                <tr>
                    <td><strong>Autocompletado</strong></td>
                    <td>IDE sugiere rutas disponibles</td>
                    <td>Desarrollo m√°s r√°pido</td>
                </tr>
                <tr>
                    <td><strong>Refactorizaci√≥n</strong></td>
                    <td>Cambios propagan autom√°ticamente</td>
                    <td>Mantenimiento simplificado</td>
                </tr>
                <tr>
                    <td><strong>Jerarqu√≠a Clara</strong></td>
                    <td>Todas las rutas en un solo lugar</td>
                    <td>Mejor organizaci√≥n</td>
                </tr>
            </tbody>
        </table>

        <h3>üîó Rutas con Argumentos</h3>
        <p>
            Para pasar datos entre pantallas, Navigation Compose soporta argumentos en la URL.
        </p>

        <div class="box box-info">
            <h4>üìñ Patrones de Argumentos:</h4>
            <pre><code>// 1. Definir patr√≥n con placeholder
const val routePattern = "producto/{productoId}"

// 2. Funci√≥n helper para crear ruta con valor real
fun createRoute(productoId: String) = "producto/$productoId"

// 3. Navegar usando la funci√≥n helper
navController.navigate(
    Screen.DetalleProducto.createRoute(productoId = "polera_123")
)
// Resultado: "producto/polera_123"

// 4. Extraer argumento en el destino
composable(Screen.DetalleProducto.routePattern) { backStackEntry ->
    val productoId = backStackEntry.arguments?.getString("productoId")
    DetalleProductoScreen(productoId = productoId ?: "")
}</code></pre>
        </div>

        <h4>üìã Tipos de Argumentos Soportados:</h4>
        <ul>
            <li><strong>String:</strong> Textos, IDs (default)</li>
            <li><strong>Int:</strong> N√∫meros enteros</li>
            <li><strong>Long:</strong> N√∫meros grandes</li>
            <li><strong>Float:</strong> Decimales</li>
            <li><strong>Boolean:</strong> true/false</li>
            <li><strong>Nullable:</strong> Argumentos opcionales con "?"</li>
        </ul>

        <h2>üöÄ Configuraci√≥n de Navegaci√≥n - AppNavigation.kt</h2>
        <p>
            El <code>NavHost</code> es el contenedor que muestra la pantalla actual seg√∫n la ruta activa.
        </p>

        <div class="box box-success">
            <pre><code>@Composable
fun AppNavigation() {
    // 1. Crear NavController
    val navController = rememberNavController()

    // 2. ViewModels compartidos entre pantallas
    val usuarioViewModel: UsuarioViewModel = viewModel()
    val carritoViewModel: CarritoViewModel = viewModel()

    // 3. Configurar NavHost
    NavHost(
        navController = navController,
        startDestination = Screen.StartScreen.route
    ) {
        // Rutas simples
        composable(Screen.StartScreen.route) {
            StartScreen(navController)
        }

        composable(Screen.Login.route) {
            LoginScreen(navController, usuarioViewModel)
        }

        composable(Screen.Registro.route) {
            RegistroScreen(navController, usuarioViewModel)
        }

        composable(Screen.Home.route) {
            HomeScreen(
                navController = navController,
                usuarioViewModel = usuarioViewModel,
                carritoViewModel = carritoViewModel
            )
        }

        composable(Screen.Cart.route) {
            CartScreen(
                navController = navController,
                carritoViewModel = carritoViewModel
            )
        }

        // Rutas con argumentos
        composable(
            route = Screen.DetalleProducto.routePattern,
            arguments = listOf(
                navArgument("productoId") {
                    type = NavType.StringType
                }
            )
        ) { backStackEntry ->
            val productoId = backStackEntry.arguments?.getString("productoId")
            DetalleProductoScreen(
                productoId = productoId ?: "",
                navController = navController,
                carritoViewModel = carritoViewModel
            )
        }

        composable(
            route = Screen.Success.routePattern,
            arguments = listOf(
                navArgument("numeroPedido") {
                    type = NavType.StringType
                    nullable = true
                }
            )
        ) { backStackEntry ->
            val numeroPedido = backStackEntry.arguments?.getString("numeroPedido")
            SuccessScreen(
                navController = navController,
                numeroPedido = numeroPedido
            )
        }
    }
}</code></pre>
        </div>

        <h4>üîß Componentes Clave:</h4>
        <ul>
            <li><strong>rememberNavController():</strong> Crea y recuerda el NavController</li>
            <li><strong>NavHost:</strong> Contenedor que aloja todos los destinos</li>
            <li><strong>startDestination:</strong> Ruta inicial de la app</li>
            <li><strong>composable:</strong> Define un destino de navegaci√≥n</li>
            <li><strong>navArgument:</strong> Configura argumentos con tipo y opciones</li>
            <li><strong>backStackEntry:</strong> Acceso a argumentos y estado del destino</li>
        </ul>

        <h2>üé¨ Navegaci√≥n Program√°tica</h2>

        <h3>1Ô∏è‚É£ Navegaci√≥n Simple</h3>
        <div class="box box-info">
            <pre><code>// Navegar a una pantalla
Button(onClick = {
    navController.navigate(Screen.Login.route)
}) {
    Text("Ir a Login")
}

// Navegar con argumentos
Button(onClick = {
    navController.navigate(
        Screen.DetalleProducto.createRoute(productoId = "polera_123")
    )
}) {
    Text("Ver Detalle")
}</code></pre>
        </div>

        <h3>2Ô∏è‚É£ Navegaci√≥n con Opciones</h3>
        <div class="box box-warning">
            <pre><code>// Limpiar back stack (login exitoso)
navController.navigate(Screen.Home.route) {
    popUpTo(Screen.StartScreen.route) {
        inclusive = true
    }
    launchSingleTop = true
}

// Pop hasta destino espec√≠fico
navController.navigate(Screen.Cart.route) {
    popUpTo(Screen.Home.route) {
        inclusive = false  // Mantener Home en el stack
    }
}

// Evitar duplicados en el stack
navController.navigate(Screen.Profile.route) {
    launchSingleTop = true  // Si ya est√° arriba, no duplicar
}</code></pre>
        </div>

        <h4>‚öôÔ∏è Opciones de Navegaci√≥n:</h4>
        <table>
            <thead>
                <tr>
                    <th>Opci√≥n</th>
                    <th>Descripci√≥n</th>
                    <th>Uso Com√∫n</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>popUpTo(route)</code></td>
                    <td>Elimina destinos hasta la ruta especificada</td>
                    <td>Login exitoso, logout</td>
                </tr>
                <tr>
                    <td><code>inclusive = true</code></td>
                    <td>Incluye la ruta popUpTo en la eliminaci√≥n</td>
                    <td>Limpiar completamente el stack</td>
                </tr>
                <tr>
                    <td><code>launchSingleTop</code></td>
                    <td>No duplica si ya est√° en el top</td>
                    <td>Tabs, home principal</td>
                </tr>
                <tr>
                    <td><code>restoreState</code></td>
                    <td>Restaura el estado si existe</td>
                    <td>Bottom navigation</td>
                </tr>
                <tr>
                    <td><code>saveState</code></td>
                    <td>Guarda estado al salir</td>
                    <td>Tabs con scroll position</td>
                </tr>
            </tbody>
        </table>

        <h3>3Ô∏è‚É£ Navegaci√≥n hacia Atr√°s</h3>
        <div class="box box-success">
            <pre><code>// Volver a la pantalla anterior
Button(onClick = { navController.navigateUp() }) {
    Text("Volver")
}

// Alternativa (equivalente)
Button(onClick = { navController.popBackStack() }) {
    Text("Atr√°s")
}

// Verificar si puede volver
if (navController.previousBackStackEntry != null) {
    IconButton(onClick = { navController.navigateUp() }) {
        Icon(Icons.Filled.ArrowBack, "Volver")
    }
}</code></pre>
        </div>

        <h2>üì° Eventos de Navegaci√≥n desde ViewModel</h2>
        <p>
            Para mantener la separaci√≥n de responsabilidades, la navegaci√≥n se dispara desde la UI,
            pero el ViewModel puede emitir eventos que la UI observe.
        </p>

        <div class="box box-info">
            <h4>üìÑ NavigationEvent.kt</h4>
            <pre><code>// Sealed class para eventos de navegaci√≥n
sealed class NavigationEvent {
    data class NavigateTo(
        val route: Screen,
        val popUpToRoute: Screen? = null,
        val inclusive: Boolean = false,
        val singleTop: Boolean = false
    ) : NavigationEvent()

    data object NavigateBack : NavigationEvent()
}

// En el ViewModel
class MainViewModel : ViewModel() {

    private val _navigationEvents = Channel&lt;NavigationEvent&gt;()
    val navigationEvents = _navigationEvents.receiveAsFlow()

    fun navigateToHome() {
        viewModelScope.launch {
            _navigationEvents.send(
                NavigationEvent.NavigateTo(
                    route = Screen.Home,
                    popUpToRoute = Screen.StartScreen,
                    inclusive = true
                )
            )
        }
    }

    fun navigateBack() {
        viewModelScope.launch {
            _navigationEvents.send(NavigationEvent.NavigateBack)
        }
    }
}

// En el Composable
LaunchedEffect(Unit) {
    viewModel.navigationEvents.collectLatest { event ->
        when (event) {
            is NavigationEvent.NavigateTo -> {
                navController.navigate(event.route.route) {
                    event.popUpToRoute?.let {
                        popUpTo(it.route) {
                            inclusive = event.inclusive
                        }
                    }
                    launchSingleTop = event.singleTop
                }
            }
            NavigationEvent.NavigateBack -> {
                navController.navigateUp()
            }
        }
    }
}</code></pre>
        </div>

        <h4>‚úÖ Ventajas de este Patr√≥n:</h4>
        <ul>
            <li>‚úîÔ∏è ViewModel no depende de NavController (testeable)</li>
            <li>‚úîÔ∏è L√≥gica de navegaci√≥n centralizada</li>
            <li>‚úîÔ∏è Navegaci√≥n como respuesta a operaciones (login exitoso, error, etc.)</li>
            <li>‚úîÔ∏è Un solo lugar para observar eventos de navegaci√≥n</li>
        </ul>

        <h2>üó∫Ô∏è Grafo de Navegaci√≥n de App AjiColor</h2>
        <div class="nav-graph">
            <h3 style="color: #667eea; margin-bottom: 20px;">üìç Flujo de Navegaci√≥n</h3>

            <div class="screen-box">StartScreen</div>
            <span class="arrow">‚Üí</span>
            <div class="screen-box">Login/Registro</div>
            <span class="arrow">‚Üí</span>
            <div class="screen-box">Home</div>

            <br><br>

            <div style="margin-top: 20px;">
                <div class="screen-box">Home</div>
                <span class="arrow">‚Üì</span>
            </div>

            <div style="margin-top: 20px;">
                <div class="screen-box">Cat√°logo</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">Detalle Producto</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">Carrito</div>
            </div>

            <div style="margin-top: 20px;">
                <div class="screen-box">Carrito</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">Checkout</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">Success</div>
            </div>

            <div style="margin-top: 20px;">
                <div class="screen-box">Home</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">Profile</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">OrderHistory</div>
                <span class="arrow">‚Üí</span>
                <div class="screen-box">Detalle Pedido</div>
            </div>
        </div>

        <h2>üéì Mejores Pr√°cticas de Navegaci√≥n</h2>

        <div class="box box-success">
            <h3>‚úÖ DO - Hacer</h3>
            <ul>
                <li>‚úîÔ∏è Usar Sealed Classes para definir rutas</li>
                <li>‚úîÔ∏è Crear funciones helper para rutas con argumentos</li>
                <li>‚úîÔ∏è Pasar ViewModels compartidos a trav√©s de composables</li>
                <li>‚úîÔ∏è Usar popUpTo para limpiar back stack apropiadamente</li>
                <li>‚úîÔ∏è Validar argumentos con valores por defecto</li>
                <li>‚úîÔ∏è Emitir eventos de navegaci√≥n desde ViewModel</li>
            </ul>
        </div>

        <div class="box box-warning">
            <h3>‚ùå DON'T - Evitar</h3>
            <ul>
                <li>‚ùå No usar strings literales para rutas (propenso a errores)</li>
                <li>‚ùå No pasar NavController al ViewModel</li>
                <li>‚ùå No navegar dentro de LaunchedEffect sin keys apropiadas</li>
                <li>‚ùå No olvidar manejar el bot√≥n Back del sistema</li>
                <li>‚ùå No crear ciclos infinitos en el back stack</li>
                <li>‚ùå No pasar objetos complejos por argumentos (usar IDs)</li>
            </ul>
        </div>

        <h2>üîç Deep Links y Navegaci√≥n Externa</h2>
        <p>
            Navigation Compose soporta deep links para abrir pantallas espec√≠ficas desde URLs externas.
        </p>

        <div class="box box-info">
            <pre><code>composable(
    route = Screen.DetalleProducto.routePattern,
    deepLinks = listOf(
        navDeepLink {
            uriPattern = "ajicolor://producto/{productoId}"
        },
        navDeepLink {
            uriPattern = "https://ajicolor.cl/producto/{productoId}"
        }
    ),
    arguments = listOf(
        navArgument("productoId") {
            type = NavType.StringType
        }
    )
) { backStackEntry ->
    val productoId = backStackEntry.arguments?.getString("productoId")
    DetalleProductoScreen(productoId = productoId ?: "")
}

// Uso desde notificaciones, emails, etc.
// ajicolor://producto/polera_123
// https://ajicolor.cl/producto/polera_123</code></pre>
        </div>

        <h2>üìö Resumen</h2>
        <p>
            El sistema de navegaci√≥n de App AjiColor implementa un flujo robusto y tipo-safe con:
        </p>

        <div class="box box-success">
            <ul>
                <li>‚úÖ <strong>Rutas tipo-safe</strong> con Sealed Classes</li>
                <li>‚úÖ <strong>Argumentos validados</strong> en tiempo de compilaci√≥n</li>
                <li>‚úÖ <strong>Gesti√≥n del back stack</strong> apropiada</li>
                <li>‚úÖ <strong>ViewModels compartidos</strong> entre destinos</li>
                <li>‚úÖ <strong>Eventos de navegaci√≥n</strong> desde ViewModel</li>
                <li>‚úÖ <strong>Deep links</strong> para navegaci√≥n externa</li>
                <li>‚úÖ <strong>Navegaci√≥n declarativa</strong> con Compose</li>
            </ul>
        </div>

        <p style="text-align: center; margin-top: 40px; font-size: 1.1em; color: #667eea;">
            <strong>üß≠ Navegaci√≥n tipo-safe = Menos errores + Mejor experiencia</strong>
        </p>
    </div>
</body>
</html>
